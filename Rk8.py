import numpy as np

def rk8_dop853_step(f, t, y, h):
    c = np.array([
        0.0,
        1/18,
        1/12,
        1/8,
        5/16,
        3/8,
        59/400,
        93/200,
        5490023248/9719169821,
        13/20,
        1201146811/1299019798,
        1.0,
        1.0,
    ], dtype=float)

    a = np.zeros((13, 12), dtype=float)

    a[1, 0] = 1/18

    a[2, 0] = 1/48
    a[2, 1] = 1/16

    a[3, 0] = 1/32
    a[3, 2] = 3/32

    a[4, 0] = 5/16
    a[4, 2] = -75/64
    a[4, 3] = 75/64

    a[5, 0] = 3/80
    a[5, 3] = 3/16
    a[5, 4] = 3/20

    a[6, 0] = 29443841/614563906
    a[6, 3] = 77736538/692538347
    a[6, 4] = -28693883/1125000000
    a[6, 5] = 23124283/1800000000

    a[7, 0] = 16016141/946692911
    a[7, 3] = 61564180/158732637
    a[7, 4] = 22789713/633445777
    a[7, 5] = 545815736/2771057229
    a[7, 6] = -180193667/1043307555

    a[8, 0] = 39632708/573591083
    a[8, 3] = -433636366/683701615
    a[8, 4] = -421739975/2616292301
    a[8, 5] = 100302831/723423059
    a[8, 6] = 790204164/839813087
    a[8, 7] = 800635310/3783071287

    a[9, 0] = 246121993/1340847787
    a[9, 3] = -37695042795/15268766246
    a[9, 4] = -309121744/1061227803
    a[9, 5] = -12992083/490766935
    a[9, 6] = 6005943493/2108947869
    a[9, 7] = 393006217/1396673457
    a[9, 8] = 123872331/1001029789

    a[10, 0] = -1028468189/846180014
    a[10, 3] = 8478235783/508512852
    a[10, 4] = 1311729495/1432422823
    a[10, 5] = -10304129995/1701304382
    a[10, 6] = -48777925059/3047939560
    a[10, 7] = 15336726248/1032824649
    a[10, 8] = -45442868181/3398467696
    a[10, 9] = 3065993473/597172653

    a[11, 0]  = 185892177/718116043
    a[11, 3]  = -3185094517/667107341
    a[11, 4]  = -477755414/1098053517
    a[11, 5]  = -703635378/230739211
    a[11, 6]  = 5731566787/1027545527
    a[11, 7]  = 5232866602/850066563
    a[11, 8]  = -4093664535/808688257
    a[11, 9]  = 3962137247/1805957418
    a[11,10] = 65686358/487910083

    a[12, 0]  = 403863854/491063109
    a[12, 3]  = -5068492393/434740067
    a[12, 4]  = -411421997/543043805
    a[12, 5]  = 652783627/914296604
    a[12, 6]  = 11173962825/925320556
    a[12, 7]  = -13158990841/6184727034
    a[12, 8]  = 3936647629/1978049680
    a[12, 9]  = -160528059/685178525
    a[12,10] = 248638103/1413531060

    b = np.array([
        14005451/335480064,
        0.0,
        0.0,
        0.0,
        0.0,
        -59238493/1068277825,
        181606767/758867731,
        561292985/797845732,
        -1041891430/1371343529,
        760417239/1151165299,
        118820643/751138087,
        -528747749/2220607170,
        1/4
    ], dtype=float)

    k = []
    for i in range(13):
        yi = y
        if i > 0:
            s = np.zeros_like(y)
            for j in range(i):
                s += a[i, j] * k[j]
            yi = y + h * s

        k.append(f(t + c[i] * h, yi))

    incr = np.zeros_like(y)
    for i in range(13):
        incr += b[i] * k[i]

    return y + h * incr

def lorenz(x, y, z, s, r, B):
    dx = s * (y - x)
    dy = x * (r - z) - y
    dz = x * y - B * z
    return dx, dy, dz

def runge_kutta(init, system, sub_method, dt, s, r, B, num_steps_to_stop):
    x = np.zeros(num_steps_to_stop)
    y = np.zeros(num_steps_to_stop)
    z = np.zeros(num_steps_to_stop)
    x[0], y[0], z[0] = init

    for i in range(num_steps_to_stop - 1):
        x[i+1], y[i+1], z[i+1] = sub_method(x[i], y[i], z[i], dt, system, s, r, B)

    return x, y, z

def runge_kutta_8(x, y, z, dt, system, s, r, B):

    y_vec = np.array([x, y, z], dtype=float)

    def f(t, Y):
        dx, dy, dz = system(Y[0], Y[1], Y[2], s, r, B)
        return np.array([dx, dy, dz], dtype=float)

    y_next = rk8_dop853_step(f, 0.0, y_vec, dt)
    return float(y_next[0]), float(y_next[1]), float(y_next[2])

if __name__ == "__main__":
    if RK8:
        x, y, z = model(runge_kutta, init, lorenz, runge_kutta_8, dt, s, r, B, num_steps_to_stop)
        method = runge_kutta
        sub_method = runge_kutta_8
        model_str = "RK8"